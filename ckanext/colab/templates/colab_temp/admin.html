{% extends "page.html" %}
{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="/adminuserform.css" />
  <style>
    /* UNESCO Data Contributor Portal Admin Theme */
    :root {
      /* UNESCO Blue Colors */
      --unesco-blue: #0072BC;
      --unesco-blue-dark: #005A9C;
      --unesco-blue-light: #009EE0;
      --unesco-blue-pale: #E3F2FD;
      
      /* Neutral Colors */
      --unesco-gray: #f8f9fa;
      --text-primary: #2c3e50;
      --text-secondary: #6c757d;
      
      /* UNESCO Blue-themed Shadows */
      --shadow-light: 0 2px 8px rgba(0, 114, 188, 0.08);
      --shadow-medium: 0 4px 16px rgba(0, 114, 188, 0.12);
      --shadow-strong: 0 8px 32px rgba(0, 114, 188, 0.16);
    }

    /* Modern Admin Interface Styles */
    .admin-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
    }

    /* Admin Header - UNESCO Style */
    .admin-header {
        position: relative;
        height: 300px;
        overflow: hidden;
        border-radius: 16px;
        margin-bottom: 3rem;
        box-shadow: var(--shadow-strong);
    }

    .admin-header-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('/colab.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        filter: brightness(0.8);
        transition: transform 0.3s ease;
    }

    .admin-header:hover .admin-header-bg {
        transform: scale(1.02);
    }

    .admin-header-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(0, 90, 156, 0.9) 0%, rgba(0, 114, 188, 0.8) 100%);
    }

    .admin-header-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: white;
        z-index: 10;
        width: 90%;
        max-width: 800px;
    }

    .admin-header h1 {
        margin: 0 0 1rem 0;
        font-size: 2.8rem;
        font-weight: 700;
        text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
        line-height: 1.2;
        letter-spacing: -0.02em;
    }

    .admin-header p {
        margin: 0;
        font-size: 1.2rem;
        opacity: 0.95;
        text-shadow: 1px 1px 4px rgba(0,0,0,0.4);
        font-weight: 300;
        line-height: 1.4;
    }

    /* Estilos espec√≠ficos para asegurar texto blanco en la cabecera */
    .admin-header-content p,
    .admin-header p,
    .admin-header-content > p {
        color: white !important;
        margin: 0 !important;
        font-size: 1.2rem !important;
        opacity: 0.95 !important;
        text-shadow: 1px 1px 4px rgba(0,0,0,0.4) !important;
        font-weight: 300 !important;
        line-height: 1.4 !important;
    }

    /* Tambi√©n asegurar que cualquier elemento de texto sea blanco */
    .admin-header-content *,
    .admin-header * {
        color: white !important;
    }

    /* Espec√≠ficamente para p√°rrafos */
    .admin-header-content p {
        color: #ffffff !important;
        text-shadow: 2px 2px 6px rgba(0,0,0,0.5) !important;
    }

    .admin-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 20px;
        box-shadow: var(--shadow-medium);
        flex: 1;
        min-width: 200px;
        text-align: center;
        border-left: 6px solid var(--unesco-blue);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-strong);
    }

    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: var(--unesco-blue);
    }

    .stat-label {
        color: var(--text-secondary);
        margin-top: 5px;
    }

    /* Enhanced Tabs - UNESCO Style */
    .tabs {
        background: white;
        border-radius: 20px;
        box-shadow: var(--shadow-medium);
        overflow: hidden;
        border-left: 6px solid var(--unesco-blue-dark);
        transition: all 0.3s ease;
    }

    .tabs:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-strong);
    }

    .tab-buttons {
        display: flex;
        background: var(--unesco-gray);
        border-bottom: 2px solid #e9ecef;
    }

    .tab-button {
        flex: 1;
        padding: 15px 20px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.3s ease;
        position: relative;
    }

    .tab-button:hover {
        background: #e9ecef;
        color: var(--text-primary);
    }

    .tab-button.active {
        color: var(--unesco-blue);
        background: white;
    }

    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--unesco-blue);
    }

    /* Search and Filter - UNESCO Style */
    .controls {
        padding: 20px;
        background: linear-gradient(135deg, #ffffff 0%, var(--unesco-gray) 100%);
        border-bottom: 1px solid #e9ecef;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
        box-shadow: var(--shadow-light);
    }

    .search-box {
        flex: 1;
        min-width: 250px;
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 12px 15px 12px 40px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-light);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--unesco-blue);
        box-shadow: var(--shadow-medium);
        transform: translateY(-1px);
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        transition: color 0.3s ease;
    }

    .search-input:focus + .search-icon {
        color: var(--unesco-blue);
    }

    .filter-select {
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 20px;
        background: white;
        font-size: 14px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-light);
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--unesco-blue);
        box-shadow: var(--shadow-medium);
        transform: translateY(-1px);
    }

    /* Enhanced Table */
    .table-container {
        overflow-x: auto;
        padding: 20px;
    }

    .admin-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        background: white;
    }

    .admin-table th {
        background: #f8f9fa;
        padding: 15px 10px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e9ecef;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .admin-table td {
        padding: 12px 10px;
        border-bottom: 1px solid #e9ecef;
        vertical-align: middle;
    }

    .admin-table tr:hover {
        background: #f8f9fa;
    }

    /* Text Truncation */
    .truncate {
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: help;
    }

    .truncate-long {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: help;
    }

    .email-full {
        min-width: 200px;
        word-break: break-all;
        font-family: monospace;
        font-size: 12px;
        line-height: 1.3;
    }

    /* Role Selector */
    .role-selector {
        margin: 5px 0;
        padding: 4px 8px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 11px;
        background: white;
        color: var(--text-primary);
        transition: all 0.3s ease;
        box-shadow: var(--shadow-light);
    }

    .role-selector:focus {
        outline: none;
        border-color: var(--unesco-blue);
        box-shadow: var(--shadow-medium);
        transform: translateY(-1px);
    }

    .role-current {
        background: var(--unesco-blue-pale);
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 10px;
        margin-bottom: 4px;
        display: block;
        color: var(--unesco-blue-dark);
        font-weight: 500;
    }

    .role-modified {
        background: #fff3cd !important;
        border-color: #ffc107 !important;
        color: #856404 !important;
        box-shadow: 0 0 8px rgba(255, 193, 7, 0.3) !important;
    }

    /* Action Buttons - UNESCO Style */
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 8px 14px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        box-shadow: var(--shadow-light);
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s ease;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-approve {
        background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%) !important;
        color: white !important;
        border: 2px solid #4caf50 !important;
    }

    .btn-approve:hover {
        background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%) !important;
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        border-color: #388e3c !important;
        color: white !important;
        text-decoration: none !important;
    }

    .btn-reject {
        background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;
        color: white !important;
        border: 2px solid #f44336 !important;
    }

    .btn-reject:hover {
        background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%) !important;
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        border-color: #d32f2f !important;
        color: white !important;
        text-decoration: none !important;
    }

    .btn-view {
        background: linear-gradient(135deg, var(--unesco-blue) 0%, var(--unesco-blue-dark) 100%) !important;
        color: white !important;
        border: 2px solid var(--unesco-blue) !important;
    }

    .btn-view:hover {
        background: linear-gradient(135deg, var(--unesco-blue-dark) 0%, #004080 100%) !important;
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        border-color: var(--unesco-blue-dark) !important;
        color: white !important;
        text-decoration: none !important;
    }

    /* Espec√≠fico para botones en tablas */
    .admin-table .btn-view,
    .action-buttons .btn-view {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        color: white !important;
        border: 2px solid #007bff !important;
        text-decoration: none !important;
    }

    .admin-table .btn-view:hover,
    .action-buttons .btn-view:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
        color: white !important;
        border-color: #0056b3 !important;
        text-decoration: none !important;
    }

    .admin-table .btn-reject,
    .action-buttons .btn-reject {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        color: white !important;
        border: 2px solid #dc3545 !important;
        text-decoration: none !important;
    }

    .admin-table .btn-reject:hover,
    .action-buttons .btn-reject:hover {
        background: linear-gradient(135deg, #c82333 0%, #bd2130 100%) !important;
        color: white !important;
        border-color: #c82333 !important;
        text-decoration: none !important;
    }

    .admin-table .btn-approve,
    .action-buttons .btn-approve {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%) !important;
        color: white !important;
        border: 2px solid #28a745 !important;
        text-decoration: none !important;
    }

    .admin-table .btn-approve:hover,
    .action-buttons .btn-approve:hover {
        background: linear-gradient(135deg, #218838 0%, #1e7e34 100%) !important;
        color: white !important;
        border-color: #218838 !important;
        text-decoration: none !important;
    }

    /* Estilos adicionales para asegurar visibilidad completa */
    a.btn-view, 
    button.btn-view,
    .btn.btn-view {
        background: #007bff !important;
        background-image: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        color: #ffffff !important;
        border: 2px solid #007bff !important;
        text-decoration: none !important;
        display: inline-block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    a.btn-view:hover, 
    button.btn-view:hover,
    .btn.btn-view:hover {
        background: #0056b3 !important;
        background-image: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
        color: #ffffff !important;
        border-color: #0056b3 !important;
        text-decoration: none !important;
        opacity: 1 !important;
    }

    a.btn-reject, 
    button.btn-reject,
    .btn.btn-reject {
        background: #dc3545 !important;
        background-image: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        color: #ffffff !important;
        border: 2px solid #dc3545 !important;
        text-decoration: none !important;
        display: inline-block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    a.btn-reject:hover, 
    button.btn-reject:hover,
    .btn.btn-reject:hover {
        background: #c82333 !important;
        background-image: linear-gradient(135deg, #c82333 0%, #bd2130 100%) !important;
        color: #ffffff !important;
        border-color: #c82333 !important;
        text-decoration: none !important;
        opacity: 1 !important;
    }

    a.btn-approve, 
    button.btn-approve,
    .btn.btn-approve {
        background: #28a745 !important;
        background-image: linear-gradient(135deg, #28a745 0%, #218838 100%) !important;
        color: #ffffff !important;
        border: 2px solid #28a745 !important;
        text-decoration: none !important;
        display: inline-block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    a.btn-approve:hover, 
    button.btn-approve:hover,
    .btn.btn-approve:hover {
        background: #218838 !important;
        background-image: linear-gradient(135deg, #218838 0%, #1e7e34 100%) !important;
        color: #ffffff !important;
        border-color: #218838 !important;
        text-decoration: none !important;
        opacity: 1 !important;
    }

    /* Estilos espec√≠ficos para la columna de acciones */
    .action-buttons {
        min-width: 180px !important;
    }

    .action-buttons a,
    .action-buttons button {
        font-size: 12px !important;
        font-weight: 600 !important;
        min-width: 70px !important;
        text-align: center !important;
        white-space: nowrap !important;
    }

    /* Fallback para cualquier problema de herencia */
    td .btn,
    .admin-table td .btn,
    .action-buttons .btn {
        background-clip: border-box !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
    }

    /* Status Badges */
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-approved {
        background: #d4edda;
        color: #155724;
    }

    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }

    /* Modal Styles - UNESCO Theme */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 90, 156, 0.5);
        animation: fadeIn 0.3s ease;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 20px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        animation: slideIn 0.3s ease;
        box-shadow: var(--shadow-strong);
        border-left: 6px solid var(--unesco-blue);
    }

    .modal-header {
        background: linear-gradient(135deg, var(--unesco-blue) 0%, var(--unesco-blue-dark) 100%);
        color: white;
        padding: 20px;
        border-radius: 20px 20px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.5em;
        font-weight: 600;
        text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
    }

    .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: white;
        opacity: 0.8;
        transition: all 0.3s ease;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
    }

    .close:hover {
        opacity: 1;
        background: rgba(255,255,255,0.2);
        transform: scale(1.1);
    }

    .modal-body {
        padding: 25px;
    }

    .detail-group {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e9ecef;
        background: linear-gradient(135deg, #ffffff 0%, var(--unesco-gray) 100%);
        padding: 15px;
        border-radius: 12px;
        box-shadow: var(--shadow-light);
    }

    .detail-group:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .detail-label {
        font-weight: 600;
        color: var(--unesco-blue-dark);
        margin-bottom: 8px;
        font-size: 1.1em;
    }

    .detail-value {
        color: var(--text-primary);
        word-wrap: break-word;
        line-height: 1.5;
    }

    /* Responsive Design - UNESCO Theme */
    @media (max-width: 768px) {
        .admin-header {
            height: 250px;
            margin-bottom: 2rem;
        }
        
        .admin-header h1 {
            font-size: 2rem;
        }
        
        .admin-header p {
            font-size: 1.1rem;
        }
        
        .admin-stats {
            flex-direction: column;
        }
        
        .controls {
            flex-direction: column;
            align-items: stretch;
            padding: 15px;
        }
        
        .search-box {
            min-width: auto;
        }
        
        .admin-table {
            font-size: 12px;
        }
        
        .admin-table th,
        .admin-table td {
            padding: 8px 5px;
        }
        
        .truncate {
            max-width: 100px;
        }
        
        .truncate-long {
            max-width: 120px;
        }
        
        .modal-content {
            width: 95%;
            margin: 10% auto;
        }
        
        .modal-body {
            padding: 15px;
        }
    }

    @media (max-width: 480px) {
        .admin-header {
            height: 200px;
            border-radius: 8px;
        }
        
        .admin-header h1 {
            font-size: 1.8rem;
        }
        
        .tabs {
            border-radius: 8px;
        }
        
        .stat-card {
            border-radius: 8px;
        }
        
        .modal-content {
            border-radius: 8px;
        }
        
        .modal-header {
            border-radius: 8px 8px 0 0;
        }
    }

    /* Navigation between panels */
    .admin-nav {
        margin-bottom: 2rem;
        background: white;
        border-radius: 16px;
        box-shadow: var(--shadow-medium);
        padding: 1rem;
        border-left: 6px solid var(--unesco-blue);
    }

    .nav-tabs {
        border: none;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .nav-tab {
        padding: 12px 24px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        background: white;
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: var(--shadow-light);
    }

    .nav-tab:hover {
        background: var(--unesco-blue-pale);
        color: var(--unesco-blue-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        text-decoration: none;
    }

    .nav-tab.active {
        background: var(--unesco-blue);
        color: white;
        border-color: var(--unesco-blue);
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* Loading State */
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0074D9;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Tooltip */
    .tooltip {
        position: relative;
        display: inline-block;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 300px;
        background-color: #333;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -150px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
        line-height: 1.4;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }
  </style>
{% endblock %}

{% block secondary %}
{% endblock %}

{% block primary %}
<div class="admin-container">
    <section class="admin-header">
        <div class="admin-header-bg"></div>
        <div class="admin-header-overlay"></div>
        <div class="admin-header-content">
            <h1>User Management Dashboard</h1>
            <p>Manage user registrations and organization memberships</p>
        </div>
    </section>

    <!-- Navigation between admin panels -->
    <div class="admin-nav">
        <div class="nav-tabs">
            <a href="{{ h.url_for('colab.show_admin') }}" class="nav-tab active">
                üë• User Management
            </a>
            <a href="{{ h.url_for('colab.organization_admin') }}" class="nav-tab">
                üè¢ Organization Requests
            </a>
        </div>
    </div>

    <div class="admin-stats">
        <div class="stat-card">
            <div class="stat-number" id="pending-count">0</div>
            <div class="stat-label">Pending Approvals</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="approved-count">0</div>
            <div class="stat-label">Approved Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="rejected-count">0</div>
            <div class="stat-label">Rejected Users</div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="pending">
                üìã Pending (<span id="pending-tab-count">0</span>)
            </button>
            <button class="tab-button" data-tab="approved">
                ‚úÖ Approved (<span id="approved-tab-count">0</span>)
            </button>
            <button class="tab-button" data-tab="rejected">
                ‚ùå Rejected (<span id="rejected-tab-count">0</span>)
            </button>
        </div>

        <div class="controls">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" placeholder="Search by name, email, organization..." id="search-input">
            </div>
            <select class="filter-select" id="org-filter">
                <option value="">All Organizations</option>
            </select>
            <select class="filter-select" id="role-filter">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="editor">Editor</option>
                <option value="member">Member</option>
            </select>
        </div>

        <div id="pending" class="tab-content active">
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>üë§ User</th>
                            <th>üìß Contact</th>
                            <th>üè¢ Organization</th>
                            <th>üìã Details</th>
                            <th>üé≠ Role</th>
                            <th>‚ö° Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                            {% if result.approved == 'Pending' and not result.rejected %}
                                <tr data-user-id="{{ result.wins_username }}" class="user-row">
                                    <td>
                                        <div>
                                            <strong class="truncate" title="{{ result.fullname }}">{{ result.fullname }}</strong>
                                            <br>
                                            <small class="text-muted">{{ result.wins_username }}</small>
                                            <br>
                                            <small class="text-muted">{{ result.age }}y, {{ result.gender }}, {{ result.nationality }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="email-full" title="{{ result.email }}">{{ result.email }}</div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong class="truncate" title="{{ result.organization_name }}">{{ result.organization_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ result.organizationType }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="truncate" title="{{ result.title_within_organization }}">
                                            {{ result.title_within_organization }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="role-current">Current: {{ result.user_role or 'admin' }}</div>
                                        <select class="role-selector" id="role-{{ result.wins_username }}-{{ loop.index }}" data-original="{{ result.user_role or 'admin' }}">
                                            <option value="admin" {% if (result.user_role or 'admin') == 'admin' %}selected{% endif %}>Admin</option>
                                            <option value="editor" {% if result.user_role == 'editor' %}selected{% endif %}>Editor</option>
                                            <option value="member" {% if result.user_role == 'member' %}selected{% endif %}>Member</option>
                                        </select>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-view" onclick="showUserDetails('{{ result.wins_username }}')">
                                                üëÅÔ∏è View
                                            </button>
                                            <a href="#" class="btn btn-approve approve-link"
                                               data-fullname="{{ result.fullname }}"
                                               data-wins-username="{{ result.wins_username }}"
                                               data-organization-name="{{ result.organization_name }}"
                                               data-title-within-organization="{{ result.title_within_organization }}"
                                               data-new-org-description="{{ result.new_organization_description }}"
                                               data-email="{{ result.email }}"
                                               data-approved="{{ result.approved }}"
                                               data-user-role="{{ result.user_role }}"
                                               data-new-org-name="{{ result.new_organization_name }}">
                                                ‚úÖ Approve
                                            </a>
                                            <a href="#" class="btn btn-reject reject-link"
                                               data-wins-username="{{ result.wins_username }}"
                                               data-organization-name="{{ result.organization_name }}">
                                                ‚ùå Reject
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="approved" class="tab-content">
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>üë§ User</th>
                            <th>üìß Contact</th>
                            <th>üè¢ Organization</th>
                            <th>üìã Details</th>
                            <th>‚úÖ Status</th>
                            <th>‚ö° Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                            {% if result.approved and "approved by" in result.approved %}
                                <tr data-user-id="{{ result.wins_username }}" class="user-row">
                                    <td>
                                        <div>
                                            <strong class="truncate" title="{{ result.fullname }}">{{ result.fullname }}</strong>
                                            <br>
                                            <small class="text-muted">{{ result.wins_username }}</small>
                                            <br>
                                            <small class="text-muted">{{ result.age }}y, {{ result.gender }}, {{ result.nationality }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="email-full" title="{{ result.email }}">{{ result.email }}</div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong class="truncate" title="{{ result.organization_name }}">{{ result.organization_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ result.organizationType }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="truncate" title="{{ result.title_within_organization }}">
                                            {{ result.title_within_organization }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge status-approved">{{ result.approved }}</span>
                                        <div style="margin-top: 4px; font-size: 11px; color: #666;">
                                            Role: {{ result.user_role or 'admin' }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-view" onclick="showUserDetails('{{ result.wins_username }}')">
                                                üëÅÔ∏è View
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="rejected" class="tab-content">
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>üë§ User</th>
                            <th>üìß Contact</th>
                            <th>üè¢ Organization</th>
                            <th>üìã Details</th>
                            <th>‚ùå Status</th>
                            <th>üìù Reason</th>
                            <th>‚ö° Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                            {% if result.rejected and "rejected by" in result.rejected %}
                                <tr data-user-id="{{ result.wins_username }}" class="user-row">
                                    <td>
                                        <div>
                                            <strong class="truncate" title="{{ result.fullname }}">{{ result.fullname }}</strong>
                                            <br>
                                            <small class="text-muted">{{ result.wins_username }}</small>
                                            <br>
                                            <small class="text-muted">{{ result.age }}y, {{ result.gender }}, {{ result.nationality }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="email-full" title="{{ result.email }}">{{ result.email }}</div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong class="truncate" title="{{ result.organization_name }}">{{ result.organization_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ result.organizationType }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="truncate" title="{{ result.title_within_organization }}">
                                            {{ result.title_within_organization }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge status-rejected">{{ result.rejected }}</span>
                                        <div style="margin-top: 4px; font-size: 11px; color: #666;">
                                            Role: {{ result.user_role or 'admin' }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="truncate" title="{{ result.rejection_reason }}">
                                            {{ result.rejection_reason }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-view" onclick="showUserDetails('{{ result.wins_username }}')">
                                                üëÅÔ∏è View
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üë§ User Details</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
// Store all users data for filtering
let allUsers = [
    {% for result in results %}
    {
        fullname: "{{ result.fullname }}",
        wins_username: "{{ result.wins_username }}",
        email: "{{ result.email }}",
        organization_name: "{{ result.organization_name }}",
        organizationType: "{{ result.organizationType }}",
        title_within_organization: "{{ result.title_within_organization }}",
        new_organization_description: "{{ result.new_organization_description }}",
        user_role: "{{ result.user_role }}",
        approved: "{{ result.approved }}",
        rejected: "{{ result.rejected }}",
        rejection_reason: "{{ result.rejection_reason }}",
        age: "{{ result.age }}",
        gender: "{{ result.gender }}",
        nationality: "{{ result.nationality }}",
        new_organization_name: "{{ result.new_organization_name }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

document.addEventListener('DOMContentLoaded', function() {
    initializeAdmin();
    setupEventListeners();
    updateCounts();
    populateFilters();
    setupRoleSelectors();
});

function initializeAdmin() {
    // Tab functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            button.classList.add('active');
            const tabId = button.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Search functionality
    document.getElementById('search-input').addEventListener('input', filterUsers);
    document.getElementById('org-filter').addEventListener('change', filterUsers);
    document.getElementById('role-filter').addEventListener('change', filterUsers);
}

function setupEventListeners() {
    // Approve links
    document.querySelectorAll('.approve-link').forEach(link => {
        link.addEventListener('click', handleApprove);
    });

    // Reject links
    document.querySelectorAll('.reject-link').forEach(link => {
        link.addEventListener('click', handleReject);
    });

    // Modal close on outside click
    window.onclick = function(event) {
        const modal = document.getElementById('userModal');
        if (event.target === modal) {
            closeModal();
        }
    }
}

function handleApprove(event) {
    event.preventDefault();
    
    const link = event.currentTarget;
    const fullName = link.getAttribute('data-fullname');
    const winsUsername = link.getAttribute('data-wins-username');
    const organizationName = link.getAttribute('data-organization-name');
    const titleWithinOrganization = link.getAttribute('data-title-within-organization');
    const email = link.getAttribute('data-email');
    const approved = link.getAttribute('data-approved');
    const newOrgDescription = link.getAttribute('data-new-org-description');
    const userRole = link.getAttribute('data-user-role');
    const newOrgName = link.getAttribute('data-new-org-name');

    // Get the row and role selector BEFORE any DOM manipulation
    const row = link.closest('tr');
    if (!row) {
        console.error('Could not find row element');
        alert('‚ùå Error: Could not find user row');
        return;
    }
    
    const roleSelector = row.querySelector('.role-selector');
    const selectedRole = roleSelector ? roleSelector.value : (userRole || 'admin');

    const roleChange = selectedRole !== (userRole || 'admin') ? 
        `\n‚ö†Ô∏è Role will be changed from "${userRole || 'admin'}" to "${selectedRole}"` : '';
    
    const confirmMessage = `üéØ APPROVE USER\n\n` +
                          `üë§ Name: ${fullName}\n` +
                          `üîë Username: ${winsUsername}\n` +
                          `üè¢ Organization: ${organizationName}\n` +
                          `üìã Title: ${titleWithinOrganization}\n` +
                          `üìß Email: ${email}\n` +
                          `üé≠ Role: ${selectedRole}${roleChange}\n\n` +
                          `Do you want to approve this user?`;

    if (confirm(confirmMessage)) {
        // Show loading state
        link.innerHTML = '‚è≥ Processing...';
        link.style.pointerEvents = 'none';

        const formData = new FormData();
        formData.append('wins_username', winsUsername);
        formData.append('organization_name', organizationName);
        formData.append('new_organization_name', newOrgName || '0');
        formData.append('new_organization_description', newOrgDescription || 'NA');
        formData.append('user_role', selectedRole);

        fetch('/colab/admin/approve', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('‚ùå Error: ' + data.error);
                link.innerHTML = '‚úÖ Approve';
                link.style.pointerEvents = 'auto';
            } else {
                try {
                    // Simply remove the row from pending tab - it will appear in approved after page refresh
                    if (row && row.parentNode) {
                        row.remove();
                    }
                    
                    // Update counts
                    updateCounts();
                    
                    alert('‚úÖ User successfully approved!\n\n' + (data.message || 'User added to organization'));
                    
                    // Optional: Refresh the page to show the user in the approved tab
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error updating DOM:', error);
                    alert('‚úÖ User successfully approved!\n\nPlease refresh the page to see the changes.');
                    window.location.reload();
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå An error occurred while processing the approval');
            link.innerHTML = '‚úÖ Approve';
            link.style.pointerEvents = 'auto';
        });
    }
}

function handleReject(event) {
    event.preventDefault();
    
    const link = event.currentTarget;
    const username = link.getAttribute('data-wins-username');
    const organization = link.getAttribute('data-organization-name');
    
    // Get the row BEFORE any DOM manipulation
    const row = link.closest('tr');
    if (!row) {
        console.error('Could not find row element');
        alert('‚ùå Error: Could not find user row');
        return;
    }
    
    const reason = prompt("üìù Please enter the reason for rejection:");
    if (reason && reason.trim()) {
        // Show loading state
        link.innerHTML = '‚è≥ Processing...';
        link.style.pointerEvents = 'none';

        fetch(`/colab/admin/reject/${encodeURIComponent(username)}/${encodeURIComponent(organization)}/${encodeURIComponent(reason)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('‚ùå Error: ' + data.error);
                    link.innerHTML = '‚ùå Reject';
                    link.style.pointerEvents = 'auto';
                } else {
                    try {
                        // Simply remove the row from pending tab - it will appear in rejected after page refresh
                        if (row && row.parentNode) {
                            row.remove();
                        }
                        
                        // Update counts
                        updateCounts();
                        
                        alert('‚ùå User successfully rejected');
                        
                        // Optional: Refresh the page to show the user in the rejected tab
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                        
                    } catch (error) {
                        console.error('Error updating DOM:', error);
                        alert('‚ùå User successfully rejected!\n\nPlease refresh the page to see the changes.');
                        window.location.reload();
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå An error occurred while processing the rejection');
                link.innerHTML = '‚ùå Reject';
                link.style.pointerEvents = 'auto';
            });
    }
}

function showUserDetails(username) {
    const user = allUsers.find(u => u.wins_username === username);
    if (!user) return;

    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="detail-group">
            <div class="detail-label">üë§ Personal Information</div>
            <div class="detail-value">
                <strong>Full Name:</strong> ${user.fullname}<br>
                <strong>Username:</strong> ${user.wins_username}<br>
                <strong>Email:</strong> ${user.email}<br>
                <strong>Age:</strong> ${user.age} years<br>
                <strong>Gender:</strong> ${user.gender}<br>
                <strong>Nationality:</strong> ${user.nationality}
            </div>
        </div>
        
        <div class="detail-group">
            <div class="detail-label">üè¢ Organization Information</div>
            <div class="detail-value">
                <strong>Organization:</strong> ${user.organization_name}<br>
                <strong>Organization Type:</strong> ${user.organizationType}<br>
                <strong>Title/Position:</strong> ${user.title_within_organization}<br>
                <strong>User Role:</strong> ${user.user_role || 'admin'}
            </div>
        </div>
        
        ${user.new_organization_description ? `
        <div class="detail-group">
            <div class="detail-label">üìã Organization Description</div>
            <div class="detail-value">${user.new_organization_description}</div>
        </div>
        ` : ''}
        
        <div class="detail-group">
            <div class="detail-label">üìä Status Information</div>
            <div class="detail-value">
                <strong>Approval Status:</strong> ${user.approved || 'Pending'}<br>
                ${user.rejected ? `<strong>Rejection Status:</strong> ${user.rejected}<br>` : ''}
                ${user.rejection_reason ? `<strong>Rejection Reason:</strong> ${user.rejection_reason}` : ''}
            </div>
        </div>
    `;

    document.getElementById('userModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('userModal').style.display = 'none';
}

function updateCounts() {
    const pendingCount = document.querySelectorAll('#pending .user-row').length;
    const approvedCount = document.querySelectorAll('#approved .user-row').length;
    const rejectedCount = document.querySelectorAll('#rejected .user-row').length;

    document.getElementById('pending-count').textContent = pendingCount;
    document.getElementById('approved-count').textContent = approvedCount;
    document.getElementById('rejected-count').textContent = rejectedCount;
    
    document.getElementById('pending-tab-count').textContent = pendingCount;
    document.getElementById('approved-tab-count').textContent = approvedCount;
    document.getElementById('rejected-tab-count').textContent = rejectedCount;
}

function populateFilters() {
    const orgFilter = document.getElementById('org-filter');
    const organizations = [...new Set(allUsers.map(user => user.organization_name))].sort();
    
    organizations.forEach(org => {
        const option = document.createElement('option');
        option.value = org;
        option.textContent = org;
        orgFilter.appendChild(option);
    });
}

function filterUsers() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const orgFilter = document.getElementById('org-filter').value;
    const roleFilter = document.getElementById('role-filter').value;
    
    document.querySelectorAll('.user-row').forEach(row => {
        const username = row.getAttribute('data-user-id');
        const user = allUsers.find(u => u.wins_username === username);
        
        if (!user) return;
        
        const matchesSearch = !searchTerm || 
            user.fullname.toLowerCase().includes(searchTerm) ||
            user.wins_username.toLowerCase().includes(searchTerm) ||
            user.email.toLowerCase().includes(searchTerm) ||
            user.organization_name.toLowerCase().includes(searchTerm);
            
        const matchesOrg = !orgFilter || user.organization_name === orgFilter;
        const matchesRole = !roleFilter || user.user_role === roleFilter;
        
        if (matchesSearch && matchesOrg && matchesRole) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function setupRoleSelectors() {
    document.querySelectorAll('.role-selector').forEach(selector => {
        selector.addEventListener('change', function() {
            const originalRole = this.getAttribute('data-original');
            const currentRole = this.value;
            
            if (originalRole !== currentRole) {
                this.style.backgroundColor = '#fff3cd';
                this.style.borderColor = '#ffc107';
                this.style.color = '#856404';
            } else {
                this.style.backgroundColor = 'white';
                this.style.borderColor = '#e9ecef';
                this.style.color = '#333';
            }
        });
    });
}
</script>

{% endblock %}